package com.example.todesvipplayer;

import android.net.Uri;
import android.os.Bundle;
import android.view.SurfaceView;
import android.view.View;
import android.view.Window;
import android.view.WindowManager;
import android.widget.ProgressBar;
import android.widget.Toast;
import androidx.appcompat.app.AppCompatActivity;

import org.videolan.libvlc.LibVLC;
import org.videolan.libvlc.Media;
import org.videolan.libvlc.MediaPlayer;
import org.videolan.libvlc.interfaces.IVLCVout;

import java.util.ArrayList;

public class PlayerActivity extends AppCompatActivity {

    private SurfaceView surfaceView;
    private ProgressBar loading;
    private String videoUrl;

    // MOTOR VLC
    private LibVLC libVlc;
    private MediaPlayer mediaPlayer;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        // Fullscreen total
        requestWindowFeature(Window.FEATURE_NO_TITLE);
        this.getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);
        
        setContentView(R.layout.activity_player);

        videoUrl = getIntent().getStringExtra("VIDEO_URL");
        surfaceView = findViewById(R.id.vlc_surface);
        loading = findViewById(R.id.loading);
    }

    private void startVlc() {
        // 1. CONFIGURAR OPCIONES AVANZADAS DE VLC
        ArrayList<String> options = new ArrayList<>();
        // Hardware Acceleration (para que no se trabe)
        options.add("--avcodec-hw=any"); 
        // Subtítulos: Color blanco, tamaño relativo, codificación UTF-8
        options.add("--freetype-rel-fontsize=20"); 
        options.add("--freetype-color=16777215"); 
        // Buffer para redes lentas (importante para Koyeb)
        options.add("--network-caching=5000"); // 5 segundos de buffer
        
        // CREAR EL MOTOR
        libVlc = new LibVLC(this, options);
        mediaPlayer = new MediaPlayer(libVlc);

        // 2. CONECTAR LA PANTALLA (SurfaceView) CON EL MOTOR
        final IVLCVout vout = mediaPlayer.getVLCVout();
        vout.setVideoView(surfaceView);
        vout.attachViews();

        if (videoUrl != null) {
            // 3. PREPARAR EL VIDEO Y EL "DISFRAZ"
            Media media = new Media(libVlc, Uri.parse(videoUrl));
            
            // Truco: Decirle al servidor que somos Chrome (User-Agent)
            // Esto se hace a nivel de opciones de red en VLC
            media.addOption(":http-user-agent=Mozilla/5.0 (Linux; Android 10) AppleWebKit/537.36 Chrome/100.0");
            media.addOption(":http-reconnect=true"); // Reintentar si falla

            mediaPlayer.setMedia(media);
            media.release(); // Ya no necesitamos el objeto media

            // 4. INICIAR REPRODUCCIÓN
            mediaPlayer.play();

            // ESCUCHAR EVENTOS (Carga, Errores, Fin)
            mediaPlayer.setEventListener(new MediaPlayer.EventListener() {
                @Override
                public void onEvent(MediaPlayer.Event event) {
                    switch (event.type) {
                        case MediaPlayer.Event.Buffering:
                            if (event.getBuffering() < 100) {
                                loading.setVisibility(View.VISIBLE);
                            } else {
                                loading.setVisibility(View.GONE);
                            }
                            break;
                        case MediaPlayer.Event.Playing:
                            loading.setVisibility(View.GONE);
                            
                            // 5. TRUCO FINAL: ACTIVAR SUBTÍTULOS AUTOMÁTICAMENTE
                            // SpuTrack = Pista de subtítulos. -1 es desactivado.
                            // Buscamos pistas y si hay alguna, la activamos.
                            int spuCount = mediaPlayer.getSpuTracksCount();
                            if (spuCount > 0) {
                                // Activar la primera pista que encuentre (usualmente Español)
                                // Las pistas suelen tener IDs como 1, 2, 3...
                                MediaPlayer.TrackDescription[] tracks = mediaPlayer.getSpuTracks();
                                if (tracks != null && tracks.length > 0) {
                                    // tracks[0] suele ser "Desactivado", probamos tracks[1]
                                    if (tracks.length > 1) {
                                        mediaPlayer.setSpuTrack(tracks[1].id);
                                    }
                                }
                            }
                            break;
                        case MediaPlayer.Event.EncounteredError:
                            loading.setVisibility(View.GONE);
                            Toast.makeText(PlayerActivity.this, "Error de VLC: Link inaccesible", Toast.LENGTH_LONG).show();
                            break;
                    }
                }
            });
        }
    }

    @Override
    protected void onStart() {
        super.onStart();
        startVlc();
    }

    @Override
    protected void onStop() {
        super.onStop();
        if (mediaPlayer != null) {
            mediaPlayer.stop();
            mediaPlayer.getVLCVout().detachViews();
            mediaPlayer.release();
            mediaPlayer = null;
        }
        if (libVlc != null) {
            libVlc.release();
            libVlc = null;
        }
    }
}

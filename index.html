<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Reproductor con Botón CC Personalizado (Corregido)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.12/mediaelementplayer.min.css" integrity="sha256-ji1bfJaTGnyscoc7LzcV9yNJy5vGKJ0frO3KJo1oaGQ=" crossorigin="anonymous" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mediaelement/4.2.12/mediaelement-and-player.min.js" integrity="sha256-z7JbZVaNbNzLvOCFHUNrjqnZRojZbRAxgr4KU2qL0qc=" crossorigin="anonymous"></script>
    <script src="./assets/js/subtitles-octopus.js"></script>

    <style>
        .mejs-container {
            position: relative;
        }
        #custom-cc-button {
            position: absolute;
            right: 45px; 
            bottom: 10px;
            z-index: 1001; 
            width: 36px;
            height: 32px;
            background: transparent;
            border: none;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }
        #custom-captions-menu {
            position: absolute;
            right: 10px;
            bottom: 45px; 
            z-index: 1002;
            background-color: rgba(40, 40, 40, 0.9);
            border-radius: 4px;
            display: none; 
        }
        #custom-captions-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #custom-captions-menu li {
            padding: 8px 15px;
            color: white;
            cursor: pointer;
            font-size: 13px;
        }
        #custom-captions-menu li:hover {
            background-color: rgba(80, 80, 80, 0.9);
        }
    </style>
</head>
<body>

    <video id="video" width="800" height="480" controls preload="none">
        <source type="video/mp4" src="https://ia601707.us.archive.org/34/items/sukebe-elf-tanbouki-1/Sukebe%20Elf%20Tanbouki%20-%201.mkv" />
        <track src="/visor-imgen/subtitles/Sukebe Elf Tanbouki - 1.es.ass" srclang="es" label="Español" kind="subtitles" type="application/x-ass">
        <track src="/visor-imgen/subtitles/Sukebe Elf Tanbouki - 1.eng.ass" srclang="eng" label="English" kind="subtitles" type="application/x-ass">
    </video>

    <button id="custom-cc-button">CC</button>
    <div id="custom-captions-menu">
        <ul id="captions-list"></ul>
    </div>


    <script>
        new MediaElementPlayer('video', {
            features: ['playpause', 'progress', 'current', 'duration', 'volume', 'fullscreen'],
            success: function (player, node) {
                
                // ===============================================================
                // AQUÍ ESTÁ LA CORRECCIÓN
                // Usamos 'node' (el elemento de video) para encontrar el contenedor, no 'player'.
                // ===============================================================
                const container = node.closest('.mejs-container');
                const customButton = document.getElementById('custom-cc-button');
                const customMenu = document.getElementById('custom-captions-menu');

                // Si encontramos el contenedor, movemos los elementos dentro.
                if (container) {
                    container.appendChild(customButton);
                    container.appendChild(customMenu);
                }


                const captionsList = document.getElementById('captions-list');
                const videoTracks = node.querySelectorAll('track');

                videoTracks.forEach(track => {
                    const li = document.createElement('li');
                    li.textContent = track.label;
                    li.dataset.src = track.src; 
                    captionsList.appendChild(li);
                });

                const offOption = document.createElement('li');
                offOption.textContent = 'None';
                captionsList.appendChild(offOption);

                customButton.addEventListener('click', function() {
                    const menu = document.getElementById('custom-captions-menu');
                    menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
                });

                captionsList.addEventListener('click', function(e) {
                    if (e.target.tagName === 'LI') {
                        const selectedSrc = e.target.dataset.src;

                        setTimeout(function() {
                            if (selectedSrc) { 
                                if (!window.octopusInstance) {
                                    window.octopusInstance = new SubtitlesOctopus({
                                        video: node,
                                        subUrl: selectedSrc,
                                        workerUrl: '/visor-imgen/assets/js/subtitles-octopus-worker.js'
                                    });
                                } else {
                                    window.octopusInstance.setTrackByUrl(selectedSrc);
                                }
                            } else {
                                if (window.octopusInstance) window.octopusInstance.freeTrack();
                            }
                        }, 0);
                        
                        document.getElementById('custom-captions-menu').style.display = 'none';
                    }
                });
            }
        });
    </script>
</body>
</html>
